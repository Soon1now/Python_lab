{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Регистрация</title>
  <link rel="stylesheet" href="{% static '/auth/css/style_login.css' %}">
  <style>
    .error-message {
      color: #dc3545;
      font-size: 0.875rem;
      margin-top: -10px;
      margin-bottom: 10px;
      display: none;
    }
    .password-requirements {
      display: none;
      position: absolute;
      background: white;
      border: 1px solid #ced4da;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      width: 250px;
      right: -270px;
      top: 0;
    }
    .input-group:hover .password-requirements {
      display: block;
    }
    .requirement {
      color: #dc3545;
      margin: 5px 0;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
    }
    .requirement::before {
      content: "•";
      margin-right: 8px;
    }
    .requirement.valid {
      color: #28a745;
    }
    .requirement.valid::before {
      content: "✓";
    }
    .password-field-container {
      position: relative;
    }
    .form-control {
      border: 1px solid #ced4da;
      border-radius: 15px;
      padding: 10px 25px;
      width: 100%;
      transition: border-color 0.15s ease-in-out;
    }
    .form-control:focus {
      outline: none;
      border-color: #263410;
    }
    .form-control.is-invalid {
      border-color: #dc3545;
    }
    .form-control.is-valid {
      border-color: #28a745;
    }
    .input-group {
      position: relative;
    }
    .validation-icon {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      display: none;
    }
    .is-valid + .validation-icon.valid-icon {
      display: block;
      color: #28a745;
    }
    .is-invalid + .validation-icon.invalid-icon {
      display: block;
      color: #dc3545;
    }
  </style>
</head>
<body class="body">
  <div class="popups_inner">
    <div class="popup popup_registrations">
      <img src="{% static 'img/road.png' %}" alt="road" class="popup-image" />
      <span class="close-btn">
        <a href="/" style="text-decoration: none; color: white">×</a>
      </span>
      
      <h1 class="section-title2">
        Пройдите регистрацию и получите лучшее предложение
      </h1>

      {% if messages %}
      <div class="messages-container">
          <div class="messages">
              {% for message in messages %}
              <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}">
                  {{ message }}
              </div>
              {% endfor %}
          </div>
      </div>
      {% endif %}

      <form method="POST" class="form" id="registrationForm" novalidate>
        {% csrf_token %}
        <div class="mb-3">
          <h5>Фамилия</h5>
          <div class="input-group">
            <input type="text" name="last_name" class="form-control" placeholder="Введите фамилию" required />
            <span class="validation-icon valid-icon">✓</span>
            <span class="validation-icon invalid-icon">✕</span>
          </div>
          <div class="error-message" id="lastNameError"></div>
        </div>
        <div class="mb-3">
          <h5>Имя</h5>
          <div class="input-group">
            <input type="text" name="first_name" class="form-control" placeholder="Введите имя" required />
            <span class="validation-icon valid-icon">✓</span>
            <span class="validation-icon invalid-icon">✕</span>
          </div>
          <div class="error-message" id="firstNameError"></div>
        </div>
        <div class="mb-3">
          <h5>Email</h5>
          <div class="input-group">
            <input type="email" name="email" class="form-control" placeholder="example@mail.com" required />
            <span class="validation-icon valid-icon">✓</span>
            <span class="validation-icon invalid-icon">✕</span>
          </div>
          <div class="error-message" id="emailError"></div>
        </div>
        <div class="mb-3">
          <h5>Пароль</h5>
          <div class="password-field-container">
            <div class="input-group">
              <input type="password" name="password" class="form-control" id="password" placeholder="Придумайте пароль" required />
              <span class="validation-icon valid-icon">✓</span>
              <span class="validation-icon invalid-icon">✕</span>
            </div>
            <div class="password-requirements">
              <p class="requirement" id="length">Минимум 8 символов</p>
              <p class="requirement" id="uppercase">Минимум 1 прописная буква</p>
              <p class="requirement" id="lowercase">Минимум 1 строчная буква</p>
              <p class="requirement" id="number">Минимум 1 цифра</p>
              <p class="requirement" id="special">Минимум 1 специальный символ</p>
            </div>
          </div>
        </div>
        <input type="submit" value="Зарегистрироваться" />
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('registrationForm');
      const inputs = form.querySelectorAll('input[required]');
      const password = document.getElementById('password');
      
      const requirements = {
        length: /.{8,}/,
        uppercase: /[A-Z]/,
        lowercase: /[a-z]/,
        number: /[0-9]/,
        special: /[!@#$%^&*(),.?":{}|<>]/
      };

      // Функция валидации email
      function validateEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
      }

      // Функция валидации имени/фамилии
      function validateName(name) {
        return name.trim().length >= 2 && /^[А-ЯЁA-Z][а-яА-ЯёЁa-zA-Z\s-]+$/.test(name);
      }

      // Функция проверки пароля
      function checkPassword() {
        const value = password.value;
        let isValid = true;

        for (const [requirement, regex] of Object.entries(requirements)) {
          const element = document.getElementById(requirement);
          if (regex.test(value)) {
            element.classList.add('valid');
          } else {
            element.classList.remove('valid');
            isValid = false;
          }
        }

        return isValid;
      }

      // Функция валидации поля
      function validateField(input) {
        const errorElement = document.getElementById(input.name + 'Error');
        let isValid = true;
        let errorMessage = '';

        switch(input.name) {
          case 'email':
            if (!validateEmail(input.value)) {
              isValid = false;
              errorMessage = 'Введите корректный email адрес';
            }
            break;
          case 'first_name':
          case 'last_name':
            if (!validateName(input.value)) {
              isValid = false;
              errorMessage = 'Имя должно начинаться с заглавной буквы и содержать только буквы, пробелы и дефис';
            }
            break;
          case 'password':
            if (!checkPassword()) {
              isValid = false;
              errorMessage = 'Пароль не соответствует требованиям';
            }
            break;
        }

        // Обновляем визуальное состояние поля
        if (input.value.trim() === '') {
          input.classList.remove('is-valid', 'is-invalid');
          errorElement.style.display = 'none';
        } else {
          input.classList.toggle('is-valid', isValid);
          input.classList.toggle('is-invalid', !isValid);
          errorElement.textContent = errorMessage;
          errorElement.style.display = isValid ? 'none' : 'block';
        }

        return isValid;
      }

      // Добавляем обработчики событий для всех полей
      inputs.forEach(input => {
        // Валидация при вводе
        input.addEventListener('input', function() {
          validateField(this);
        });

        // Валидация при потере фокуса
        input.addEventListener('blur', function() {
          validateField(this);
        });
      });

      // Валидация формы перед отправкой
      form.addEventListener('submit', function(e) {
        let isValid = true;
        
        inputs.forEach(input => {
          if (!validateField(input)) {
            isValid = false;
          }
        });

        if (!isValid) {
          e.preventDefault();
        }
      });
    });
  </script>

  <style>
    .messages-container {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      width: 100%;
      max-width: 600px;
      pointer-events: none;
    }
    .messages {
      width: 100%;
      padding: 10px;
    }
    .alert {
      padding: 15px 20px;
      margin-bottom: 10px;
      border-radius: 5px;
      text-align: center;
      font-family: "Jura", sans-serif;
      font-size: 16px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      pointer-events: auto;
    }
    .alert-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .alert-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</body>
</html>



